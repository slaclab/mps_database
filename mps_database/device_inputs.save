#!/bin/bash
# This script reads the PVs with the number of remaining
# seconds on active bypasses. It should be used prior to
# rebooting the MPS Central Node IOC.
#
# It reads the *BYPD/*BYPV PVs and generates another script
# that will restore the remaining seconds to the *BYPT PVs
#
# This script is generated by the export_epics.py that
# is executed as part of the MPS Database release process
#
# Generated on Tue Jun 15 11:57:29 2021
#

function getBypass {
  time=`caget -t $1`
  value=`caget -t -n $3`
  if [ $? != '0' ]; then
    echo 'ERROR: failed to get bypass status '$1
    echo 'Please try running this script again'
    exit 1
  fi
  if [ $time != '0' ]; then
    echo '  caput '$2' '${time} >> $5
    echo '  caput '$3' '${value} >> $5
    echo '  echo '$4 >> $5
    bypassCount=$[bypassCount + 1]
  fi
}

msg='*** This will save the current bypass times and values ***'
hasRestore='0'
if [ -f $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore ]; then
   hasRestore='1'
   timestamp=`date +'%m-%d-%y-%H:%M:%S'`
   newFile=$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore-$timestamp
   msg=$msg'

The current restore file will be saved with the timestamp '$timestamp' in the name'
fi

msg=$msg'

Proceed?'
zenity --question --text "$msg" --ok-label=YES --cancel-label=NO --title "MPS Digital Input Bypass"

bypassCount=0
if [ $? == '1' ]; then
  echo 'Save bypass cancelled.'
  exit 1
fi

if [ $hasRestore == '1' ]; then
  echo 'INFO: found existing restore file, saving it with current timestamp ('$newFile')'
  mv -f $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore $newFile
fi

echo 'INFO: getting current bypasses...'

echo '#!/bin/bash ' >> $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore
echo '# ' >> $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore
echo '# Bypass restore file generated on '`date`'' >> $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore
echo '# ' >> $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore
echo 'date="'`date`'"' >> $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore
echo 'msg="This will restore device input (digital) bypasses saved on $date."' >> $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore
echo 'msg=$msg"\n\nProceed?"' >> $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore
echo 'zenity --question --text "$msg" --ok-label=YES --cancel-label=NO --title "MPS Digital Input Bypass"' >> $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore
(
echo '(' >> $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore
echo '  bypassCount=0' >> $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore
echo 5.882352941176471
getBypass PROF:GUNB:753:IN_LMTSW_BYPT PROF:GUNB:753:IN_LMTSW_BYPD PROF:GUNB:753:IN_LMTSW_BYPV 5.882352941176471 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 11.764705882352942
getBypass PROF:GUNB:753:OUT_LMTSW_BYPT PROF:GUNB:753:OUT_LMTSW_BYPD PROF:GUNB:753:OUT_LMTSW_BYPV 11.764705882352942 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 17.647058823529413
getBypass SOLN:GUNB:212:TEMP_SUM_BYPT SOLN:GUNB:212:TEMP_SUM_BYPD SOLN:GUNB:212:TEMP_SUM_BYPV 17.647058823529413 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 23.529411764705884
getBypass SOLN:GUNB:823:TEMP_SUM_BYPT SOLN:GUNB:823:TEMP_SUM_BYPD SOLN:GUNB:823:TEMP_SUM_BYPV 23.529411764705884 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 29.411764705882355
getBypass SOLN:GUNB:212:FLOW_SW_BYPT SOLN:GUNB:212:FLOW_SW_BYPD SOLN:GUNB:212:FLOW_SW_BYPV 29.411764705882355 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 35.294117647058826
getBypass ACCL:GUNB:455:TEMP_SUM_BYPT ACCL:GUNB:455:TEMP_SUM_BYPD ACCL:GUNB:455:TEMP_SUM_BYPV 35.294117647058826 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 41.1764705882353
getBypass ACCL:GUNB:455:FLOW_SW_BYPT ACCL:GUNB:455:FLOW_SW_BYPD ACCL:GUNB:455:FLOW_SW_BYPV 41.1764705882353 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 47.05882352941177
getBypass VVPG:GUNB:100:STATUS_BYPT VVPG:GUNB:100:STATUS_BYPD VVPG:GUNB:100:STATUS_BYPV 47.05882352941177 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 52.94117647058824
getBypass VVPG:GUNB:941:STATUS_BYPT VVPG:GUNB:941:STATUS_BYPD VVPG:GUNB:941:STATUS_BYPV 52.94117647058824 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 58.82352941176471
getBypass SHUT:GUNB:100:OPEN_STATUS_BYPT SHUT:GUNB:100:OPEN_STATUS_BYPD SHUT:GUNB:100:OPEN_STATUS_BYPV 58.82352941176471 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 64.70588235294119
getBypass SHUT:GUNB:100:CLOSED_STATUS_BYPT SHUT:GUNB:100:CLOSED_STATUS_BYPD SHUT:GUNB:100:CLOSED_STATUS_BYPV 64.70588235294119 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 70.58823529411765
getBypass GUN:GUNB:100:TEMPBD_SUM_BYPT GUN:GUNB:100:TEMPBD_SUM_BYPD GUN:GUNB:100:TEMPBD_SUM_BYPV 70.58823529411765 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 76.47058823529412
getBypass GUN:GUNB:100:FLOW_SW_BYPT GUN:GUNB:100:FLOW_SW_BYPD GUN:GUNB:100:FLOW_SW_BYPV 76.47058823529412 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 82.35294117647058
getBypass VVMG:LLOK:500:STATUS_BYPT VVMG:LLOK:500:STATUS_BYPD VVMG:LLOK:500:STATUS_BYPV 82.35294117647058 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 88.23529411764704
getBypass FARC:GUNB:999:TEMP_SUM_BYPT FARC:GUNB:999:TEMP_SUM_BYPD FARC:GUNB:999:TEMP_SUM_BYPV 88.23529411764704 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 94.11764705882351
getBypass GUN:GUNB:100:TEMPWG_SUM_BYPT GUN:GUNB:100:TEMPWG_SUM_BYPD GUN:GUNB:100:TEMPWG_SUM_BYPV 94.11764705882351 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
echo 99.99999999999997
getBypass FARC:GUNB:999:FLOW_SW_BYPT FARC:GUNB:999:FLOW_SW_BYPD FARC:GUNB:999:FLOW_SW_BYPV 99.99999999999997 "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
  echo $bypassCount > /tmp/mps-digital-bypass-count.txt
) |
zenity --progress --percentage=0 --text="Saving digital bypass information..." --auto-close
echo ') |' >> $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore
echo 'zenity --progress --percentage=0 --text="Restoring digital bypass information..." --auto-close' >> $PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore


bypassCount=`cat /tmp/mps-digital-bypass-count.txt`


if [ $bypassCount == '0' ]; then
  echo 'INFO: found no active bypasses'
else
  echo 'INFO: Found '${bypassCount}' active bypasses'
  echo 'INFO: Please run the script "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore" to restore bypasses'
  chmod a+x "$PHYSICS_TOP/mps_configuration/0/bypass/device_inputs.restore"
fi
echo 'Done.'
